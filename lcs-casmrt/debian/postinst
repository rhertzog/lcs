#!/bin/sh
# postinst script for lcs-casmrt
#
# see: dh_installdeb(1)

set -e

MODULE="casmrt"
VER=$(dpkg-query -f '${Version}' -W lcs-$MODULE)
INDICEMAJNBR="0"

CONF="/var/lib/lcs/$MODULE"
PATHMOD="/usr/share/lcs/$MODULE"

LCSAPACHE2PATH="/etc/apache2/lcs-main/"
APACHE2CONF=$LCSAPACHE2PATH"0002_casmrt.conf"

HOSTNAME=`hostname -f`

chown -R www-data:www-data $PATHMOD/web
chmod 777 $PATHMOD/cache
chmod 777 $PATHMOD/log


case "$1" in
   install| configure)
   
if [ "$2" = "" ] || [ "$2" = "$VER" ]; then
    ##
    ## Configuration initiale du module
    ##
    #
    # Inscription du module dans applis.lcs_db
    #
    /usr/bin/mysql -e "INSERT INTO lcs_db.applis (id, name, value, descr, num_maj, version, chemin, type) VALUES ('', '$MODULE', '1', 'SERVEUR CAS Base sur le FrameworkSymfony', '$INDICEMAJNBR', '$VER', '$PATHMOD', 'M');"
 
  # GESTION DE L'INSTALLATION DE SYMFONY
  if [ -d /usr/share/php/symfony/ ]; then
         symfony -V
  else
        symf_channel="pear.symfony-project.com"
        test1=$(pear list-channels | grep $symf_channel);
        if [ "${#test1}" = 0 ]; then
                echo "channel symfony pas installe - on l'installe";
                pear channel-discover $symf_channel
        else
                echo $test1;
                pear update-channels
                pear install symfony/symfony
        fi


  fi
  
  # installer symfony puis CREER LA BDD
  /usr/bin/mysql -e "CREATE DATABASE IF NOT EXISTS CAS;"
  /usr/bin/mysql -e "USE CAS;"
  /usr/bin/mysql -e "GRANT ALL PRIVILEGES ON CAS.*TO admin@localhost;"
  /usr/bin/mysql -e "GRANT ALL PRIVILEGES ON CAS.*TO mysql_cas@localhost IDENTIFIED BY 'wawa';"
  /usr/bin/mysql -e "FLUSH PRIVILEGES;"
  cd $PATHMOD
  symfony doctrine:build-all-reload --no-confirmation

else
    echo "Mise a jour du paquet module LCS $MODULE de $2 vers $VER"
    #
    # Lecture de l'indice de maj dans la table lcs_db.applis
    #
    MAJNBR=`mysql -se "SELECT num_maj FROM lcs_db.applis WHERE name='$MODULE';"`
    let MAJNBR+=1
    if [ ! -e $CONF/Maj/maj$MAJNBR.sh ]; then
	echo "Pas de script de mise a jour a appliquer !"
    else
        while [ -e $CONF/Maj/maj$MAJNBR.sh ]; do
            echo "Application du script Maj$MAJNBR"
            $CONF/Maj/maj$MAJNBR.sh
            let MAJNBR+=1
	done
	fi
	#
	# Mise a jour du Numero de version
	#
	
        #
        # Inscription du module dans applis.lcs_db
        #
        /usr/bin/mysql -e "UPDATE lcs_db.applis SET num_maj='$INDICEMAJNBR', version='$VER' WHERE name='$MODULE';" 
        #
        # Fin de la mise a jour
        #
	echo "Termine."
    
fi
#
# Actions non liees a une installation initiale ou a une mise a jour.
#
    #
    # Mise en place du lien symbolique 
    #
    if [ ! -e /usr/share/doc/lcs-$MODULE ]; then
        ln -s /usr/share/doc/lcs/$MODULE /usr/share/doc/lcs-$MODULE
    fi
    #
    # Ajout de l'alias
    #
    echo "Mise en place de l'alias $MODULE"
    if [ -d $LCSAPACHE2PATH ] && [ ! -e $APACHE2CONF ] ; then
      cat >$APACHE2CONF <<EOF
Alias /casmrt/ /usr/share/lcs/casmrt/web/

<Directory /usr/share/lcs/casmrt/web>
        DirectoryIndex index.php
        AllowOverride All
        Allow From All
        php_admin_value register_globals off
        php_admin_value open_basedir /.:/tmp:/usr/share/php:/var/www/lcs/:/var/www/lcs/includes/:/var/www/Annu/includes
        php_value include_path ".:../lib/vendor:./includes/:/usr/share/php:/var/www:/var/www/lcs/:/var/www/lcs/includes
</Directory>

EOF
    /etc/init.d/apache2 reload > /dev/null 2>&1
  fi

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#
#Se rendre dans l'arbo du module
cd $PATHMOD
symfony cc

exit 0


