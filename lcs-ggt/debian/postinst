#!/bin/sh
# postinst script 
#
# see: dh_installdeb(1)

set -e

MODULE="Ggt"
module=`echo $MODULE | tr [:upper:] [:lower:]`
VER=$(dpkg-query -f '${Version}' -W lcs-$module)
PATHMOD="/usr/share/lcs/Plugins/$MODULE"
INDICEMAJNBR="0"
DESCRIPT="Gestion de groupes de travail"
CONF="/var/lib/lcs/$MODULE"

case "$1" in
   install| configure)
 
CHEMIN=`pwd`   

if [ "$2" = "" -o "$2" = "$VER" ] ; then

#----------------
#install initiale 
#----------------
    #-----------------------------
    # patch des fichiers
    #-----------------------------
    pass=`pwgen -1`
    sed -i "s/#PASS#/$pass/g" $CONF/Sql/install_mysql.sql
    sed -i "s/#PASS#/$pass/g" $PATHMOD/Includes/config.inc.php
    #-----------------------------    
    #installation de la base mysql
    #-----------------------------
    
    if [ -e $CONF/Sql/install_mysql.sql ]; then
    echo "Installation de la base MySQL"
    mysql < $CONF/Sql/install_mysql.sql
    else
	echo "Pas de base mysql a installer"
	fi
	
    
    #-------------------------------
    # Inscription dans applis.lcs_db
    #-------------------------------
    
    /usr/bin/mysql -e "INSERT INTO lcs_db.applis (id, name, value, descr, num_maj, version, chemin, type) VALUES ('', '$module', '1', '$DESCRIPT', 
'$INDICEMAJNBR', '$VER', '$MODULE', 'N');"

else

#-----------
#Mise a jour
#-----------
	
    echo "Mise a jour du paquet module LCS $MODULE de $2 vers $VER"
    
    #-------------------------------------------------------
    # Lecture de l'indice de maj dans la table lcs_db.applis
    #-------------------------------------------------------
    
    REF=`mysql -se "SELECT num_maj FROM lcs_db.applis WHERE name='$module';"`
    MAJNBR=$REF
    MAJNBR=$((MAJNBR+1))
    if [ ! -e $CONF/Maj/maj.$MAJNBR ]; then
	echo "Pas de script de mise a jour a appliquer !"
    else
    
    #--------------------------------
    #Execution des instructions mysql
    #--------------------------------
    
    MAJNBR=$REF
    MAJNBR=$((MAJNBR+1))
    if [ -e $CONF/Maj/mysql.$MAJNBR ]; then
    echo "Execution des instructions MySQL des mises a jour"
    
        while [ -e $CONF/Maj/mysql.$MAJNBR ]; do
            echo " - Application du script mysql.$MAJNBR"
            mysql < $CONF/Maj/mysql.$MAJNBR
            MAJNBR=$((MAJNBR+1))
	done
    fi

    #---------------------
    #Execution des scripts
    #---------------------
    
    MAJNBR=$REF
    MAJNBR=$((MAJNBR+1))
        while [ -e $CONF/Maj/maj.$MAJNBR ]; do
            echo "Application du script Maj$MAJNBR"
            $CONF/Maj/maj.$MAJNBR
            MAJNBR=$((MAJNBR+1))
	done
	
  fi
  # fin de la maj par les scripts mysql,bash
	
	#---------------------------------
	# Mise a jour du Numero de version
	#---------------------------------
	
	
        #
        # Inscription du module dans applis.lcs_db
        #
        /usr/bin/mysql -e "UPDATE lcs_db.applis SET num_maj='$INDICEMAJNBR', version='$VER', name='$module', type='N' WHERE  name='$module' ;" 
        #
        # Fin de la mise a jour
        #
	    
fi
	#
	# 
	echo "Changement des droits sur l'arborescence du module"
	#
	$CONF/Scripts/chown.sh $MODULE
	cd $CHEMIN
	echo "Fin de l'installation"
;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0

