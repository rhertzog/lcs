#!/bin/sh
#
# Copyright (C) 2010 Cyril Bouthors <cyril@bouthors.org>
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.
#

set -e

read login
read password
read smb_share

if [ -z "$login" -o -z "$password" -o -z "$smb_share" ]
then
    echo "$0: too few parameters" >&2
    exit 1
fi

# Filter for safety...
login=$(echo "$login" | tr -dc "A-Za-z0-9_-.")

conffile="/etc/auto.zonep"
lockfile="/var/lock/lcs-zonep-update-credentials"
credfile="/var/lib/lcs/zonep/cred.$login"

# Lock
dotlockfile -p $lockfile || exit 1

# Remove lock on any exit
trap "dotlockfile -u $lockfile" 0

# Update AutoFS configuration
oldline=$(grep -E "^$login " $conffile || true)
newline="$login -fstype=cifs,uid=$login,gid=lcs-users,credentials=$credfile :$smb_share"

if [ "$oldline" != "$newline" ]; then
    # Update the autofs configuration file only if needed
    if [ -n "$oldline" ]; then
	sed -i "/^$login / d" $conffile
    fi
    echo "$newline" >> $conffile
fi

# Always update the credentials file, it doesn't hurt
umask 0077
cat >$credfile~TMP <<END
username=$login
password=$password
END
mv $credfile~TMP $credfile

# Create symlink with user's permissions
if [ ! -L "/home/$login/zone_p" ]
then
    ln -s "/srv/zone_p/$login" "/home/$login/zone_p"
    chown -h "$login:" "/home/$login/zone_p" || true
fi

if [ "$oldline" != "$newline" ]; then
    # Configuration changed, we need to reload
    invoke-rc.d autofs reload || true
fi

# Unlock done by exit trap
exit 0
