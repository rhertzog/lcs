#!/bin/sh
# postinst script for lcs-pma
#
# see: dh_installdeb(1)

set -e

VER="2.1-2"
MODULE="pla"
VERAPPLI="0.9.8.5"
INDICEMAJNBR="0"

CONF="/var/lib/lcs/$MODULE"
PATHMOD="/usr/share/lcs/$MODULE"
APACHECONF="/etc/lcs/apache.conf"
APACHE2CONF="/etc/apache2/lcs-main/67_pla.conf"

case "$1" in
   install| configure)

if [ "$2" = "" ] || [ "$2" = "$VER" ]; then
    #
    # Inscription du module dans applis.lcs_db
    #
    /usr/bin/mysql -e "INSERT INTO lcs_db.applis (id, name, value, descr, num_maj, version, chemin, type) VALUES ('', '$MODULE', '1', 'Administration web serveur LDAPLCS', '$INDICEMAJNBR', '$VER', '$PATHMOD', 'S');"
else
    echo "Mise ajour du paquet module LCS $MODULE de $2 vers $VER"
    #
    # Lecture de l'indice de maj dans la table lcs_db.applis
    #
    MAJNBR=`mysql -se "SELECT num_maj FROM lcs_db.applis WHERE name='$MODULE';"`
    let MAJNBR+=1
    if [ ! -e $CONF/Maj/maj$MAJNBR.sh ]; then
	echo "Pas de script de mise a jour a appliquer !"
    else
        while [ -e $CONF/Maj/maj$MAJNBR.sh ]; do
            echo "Application du script Maj$MAJNBR"
            $CONF/Maj/maj$MAJNBR.sh
            let MAJNBR+=1
	done
	
	fi
	
	#
	# Mise a jour du Numero de version
	#
	#let MAJNBR-=1
        #
        # Inscription du module dans applis.lcs_db
        #
        /usr/bin/mysql -e "UPDATE lcs_db.applis SET num_maj='$INDICEMAJNBR', version='$VER' WHERE name='$MODULE';" 
        #
        # Fin de la mise a jour
        #
	echo "Termine."
    
fi
#
# Mise en place du lien symbolique 
#
if [ ! -e /usr/share/doc/lcs-$MODULE ]; then
    ln -s /usr/share/doc/lcs/$MODULE /usr/share/doc/lcs-$MODULE
fi
#
# Mise en place de 20.annu.inc
#
echo "Activation du lien dans le menu d'administration"
#suppression des liens pla commentÃ©s
grep -v '\	"Explorateur LDAP' /var/www/lcs/includes/menu.d/20annu.inc > /tmp/20annu.tmp
mv /tmp/20annu.tmp /var/www/lcs/includes/menu.d/20annu.inc

if ! grep -q '\	"Explorateur LDAP' /var/www/lcs/includes/menu.d/20annu.inc 
then
sed -i "/Annuaire/a\\\t\"Explorateur LDAP\",\"../pla/\\\\\"\ target=\'_new\'\\\\\"\",\"lcs_is_admin\"," /var/www/lcs/includes/menu.d/20annu.inc
fi

echo "Changement des droits sur l'arborescence du module"
#
$CONF/Scripts/chown.sh $MODULE

# cas de l'ancienne conf apache
if [ -e $APACHECONF ]; then
  if [ `grep -c "Alias /$MODULE/ /usr/share/lcs/$MODULE/" $APACHECONF` = 0 ]; then
    #
    # Ajout de l'alias
    #
    echo "Mise en place de l'alias $MODULE"
    echo "Alias /$MODULE/ /usr/share/lcs/$MODULE/" >> $APACHECONF
    if [ -e /etc/init.d/apache2 ]; then
        /etc/init.d/apache2 reload > /dev/null 2>&1
    else
        /etc/init.d/apache reload > /dev/null 2>&1
    fi
  fi
fi
# cas de la nouvelle configuration apache
if [ ! -e $APACHE2CONF ]; then
  cat >$APACHE2CONF <<EOF
Alias /$MODULE/ /usr/share/lcs/$MODULE/
EOF
  /etc/init.d/apache2 reload > /dev/null 2>&1
fi

;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0

