#!/bin/sh

# /usr/sbin/lcs-preinstall-config

set -e
exit_fatal() {
	echo "Fatal: $1" >&2
	exit 1
}

. /usr/share/slis/slis-common.sh

# Load LCS config
[ ! -e /etc/lcs/lcs.conf ] && exit_fatal "missing /etc/lcs/lcs.conf"

# erase prefix LCS_ in lcs.conf
sed -i "s/^LCS_//g" /etc/lcs/lcs.conf

. /etc/lcs/lcs.conf

case "$1" in
    possible)
        if [ -e "/etc/mysql/my.cnf" ] && lcs-test-mysql; then
            exit 0
        else
            exit 1
        fi
    ;;
    needed)
	exit 0
    ;;
    configure)
        #
        # Comment cdrom source in sources list
        #
        sed -i s/"^deb cdrom"/"#deb cdrom"/g /etc/apt/sources.list
        #
        # Detect mode AUTO for ldap lcsmgr and root MySQL passorwds
        #
        if [ -z "$MYSQLPW" ] || [ "$MYSQLPW" = "AUTO" ]; then
            MYSQLPW=`pwgen -1 -s 8`
            perl -pe "s/MYSQLPW.*/MYSQLPW=\\\"$MYSQLPW\\\"/" -i /etc/lcs/lcs.conf
        fi
        if [ -z "$LCSMGRPASS" ] || [ "$LCSMGRPASS" = "AUTO" ]; then
            LCSMGRPASS=`pwgen -1 -s 8`
            perl -pe "s/LCSMGRPASS.*/LCSMGRPASS=\\\"$LCSMGRPASS\\\"/" -i /etc/lcs/lcs.conf
        fi
        if [ -z "$LDAP_ADMIN_PW" ] || [ "$LDAP_ADMIN_PW" = "AUTO" ]; then
            # Ldap root password is already generated by ldapedu-server
            LDAP_ADMIN_PW=$(cat /etc/ldap.secret)
            perl -pe "s/LDAP_ADMIN_PW.*/LDAP_ADMIN_PW=\\\"$LDAP_ADMIN_PW\\\"/" -i /etc/lcs/lcs.conf
        fi
        #
        # if lcs_db exist then drop
        #
        if [ -d /var/lib/mysql/lcs_db ]; then
             mysql -e "DROP DATABASE lcs_db;"
        fi
        #
        # Prepare dump sql
        #
        LCSFULLDOMAIN=$HOSTNAME.$DOMAIN
        sed -e "s|@@VERSION_NUM@@|"$VERSION_NUM"|g" \
            -e "s|@@HOSTNAME@@|"$HOSTNAME"|g" \
            -e "s|@@LCSDOMAIN@@|"$DOMAIN"|g" \
            -e "s|@@LCSFULLDOMAIN@@|"$LCSFULLDOMAIN"|g" \
            -e "s|@@LDAP_RID@@|"${LDAP_RID:-123}"|g" \
            -e "s|@@LDAPSERVER@@|"${LDAP_SERVER:-127.0.0.1}"|g" \
            -e "s|@@LDAP_MASTER_SERVER@@|"${LDAP_MASTER_SERVER:-127.0.0.1}"|g" \
            -e "s|@@LDAPPORT@@|"${LDAP_PORT:-389}"|g" \
            -e "s|@@BASEDN@@|"$LDAP_BASE_DN"|g" \
            -e "s|@@ADMINRDN@@|"cn=$LDAP_ADMIN_RDN"|g" \
            -e "s|@@ADMINPASSWD@@|"$LDAP_ADMIN_PW"|g" \
            -e "s|@@PEOPLERDN@@|"ou=$LDAP_PEOPLE_RDN"|g" \
            -e "s|@@GROUPSRDN@@|"ou=$LDAP_GROUPS_RDN"|g" \
            -e "s|@@COMPUTERSRDN@@|"ou=$LDAP_COMPUTERS_RDN"|g" \
            -e "s|@@PARKSRDN@@|"ou=$LDAP_PARKS_RDN"|g" \
            -e "s|@@RIGHTSRDN@@|"ou=$LDAP_RIGHTS_RDN"|g" \
            -e "s|@@TRASHRDN@@|"ou=$LDAP_TRASH_RDN"|g" \
            -e "s|@@AD_AUTH_DELEGATION@@|${AD_AUTH_DELEGATION:-false}|g" \
            -e "s|@@AD_SERVER@@|$AD_SERVER|g" \
            -e "s|@@AD_BASE_DN@@|$AD_SERVER|g" \
            -e "s|@@AD_BIND_DN@@|$AD_BIND_DN|g" \
            -e "s|@@AD_BIND_PW@@|$AD_BIND_PW|g" \
            -e "s|@@NTP_SERVER@@|"$NTP_SERVER"|g" \
            -e "s|@@GATEWAY@@|"$GATEWAY"|g" \
            -e "s|@@IPLCS@@|"$IPADDR0"|g" \
            -e "s|@@NETWORK@@|"$NETWORK"|g" \
            -e "s|@@NETMASK@@|"$NETMASK0"|g" \
            -e "s|@@BROADCAST@@|"$BROADCAST"|g" \
            -e "s|@@DNS1@@|"$DNS_PRIMARY"|g" \
            -e "s|@@DNS2@@|"$DNS_SECONDARY"|g" \
            -e "s|@@XENNET@@|"$XEN_NETWORK"|g" \
            -e "s|@@RELAYHOST@@|"$RELAY_HOST"|g" \
            -e "s|@@MTAIP@@|"$MTA_IP"|g" \
            -e "s|@@VLANSC@@|"$VLANSC"|g" \
            -e "s|@@VLANADMINISTRATIF@@|"$VLANADMINISTRATIF"|g" \
            -e "s|@@VLANPEDA1@@|"$VLANPEDA1"|g" \
            -e "s|@@VLANPEDA2@@|"$VLANPEDA2"|g" \
            -e "s|@@VLANPEDA3@@|"$VLANPEDA3"|g" \
            -e "s|@@VLANPEDA4@@|"$VLANPEDA4"|g" \
            -e "s|@@CACHEDIRSIZE@@|"$CACHEDIRSIZE"|g" \
            -e "s|@@SE3IP@@|"$SE3_IP"|g" \
            -e "s|@@SE3NETBIOS@@|"$SE3_NETBIOS"|g" \
            -e "s|@@SE3DOMAIN@@|"$SE3_DOMAIN"|g" \
            -e "s|@@URLMAJTGZ@@|"$URL_MAJTGZ"|g" \
            -e "s|@@URLMAJMD5@@|"$URL_MAJMD5"|g" \
            -e "s|@@URLMAJPLUG@@|"$URL_MAJPLUG"|g" \
            -e "s|@@URLMAJMOD@@|"$URL_MAJMOD"|g" \
            -e "s|@@UIDPOLICY@@|"$UID_POLICY"|g" \
            -e "s|@@DEFAULTSHELL@@|"$DEFAULT_SHELL"|g" \
            -e "s|@@TYPEGROUPS@@|"$TYPE_GROUPS"|g" \
            -e "s|@@COUNTRYNAME@@|$COUNTRYNAME|g" \
            -e "s|@@PROVINCENAME@@|$PROVINCENAME|g" \
            -e "s|@@LOCALITYNAME@@|$LOCALITYNAME|g" \
            -e "s|@@ORGANIZATIONNAME@@|$ORGANIZATIONNAME|g" \
            -e "s|@@ORGANIZATIONALUNITNAME@@|$ORGANIZATIONALUNITNAME|g" \
            -e "s|@@RNE@@|$RNE|g" \
            /var/lib/lcs/preinstall/lcs_db.sql.in > /var/lib/lcs/preinstall/lcs_db.sql
            #
            # Create base lcs_db 
            #
            mysqladmin create lcs_db
            #
            # Import dump sql
            #
            mysql lcs_db < /var/lib/lcs/preinstall/lcs_db.sql
            rm -f /var/lib/lcs/preinstall/lcs_db.sql
            #
            # Create lcsmgr account if not exist
            #
            if [ -z "`mysql -e "SELECT User FROM mysql.user WHERE user='lcsmgr';"`" ]; then
				# If Debian Squeeze
				if grep -q ^6 /etc/debian_version; then
					mysql -e "INSERT INTO mysql.user  VALUES ('localhost','lcsmgr',PASSWORD('$LCSMGRPASS'),'N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','','','','',0,0,0,0);"
					mysql -e "INSERT INTO mysql.db VALUES ('localhost','lcs_db','lcsmgr','Y','Y','Y','Y','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N');"
				else
                	mysql -e "INSERT INTO mysql.user  VALUES ('localhost', 'lcsmgr', PASSWORD( '$LCSMGRPASS' ) , 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', '', '', '', '', '0', '0', '0', '0');"
                	mysql -e "INSERT INTO mysql.db VALUES ( 'localhost', 'lcs_db', 'lcsmgr', 'Y', 'Y', 'Y', 'Y', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N');"
				fi
                mysqladmin reload
            fi
            #
            # Put root MySQL password in .my.cnf if not exist
            #
            if [ ! -e /root/.my.cnf ]; then
                mysqladmin password "$MYSQLPW"
                echo "[client]
                password=$MYSQLPW
                user=root" > /root/.my.cnf
                chmod 600 /root/.my.cnf
                mysqladmin reload -u root "-p$MYSQLPW"
            fi
            #
            # Put Time on server
            #
            if [ -n "$NTP_SERVER" ]; then
                echo "Mise à l'heure du serveur"
                /usr/sbin/ntpdate -s "$NTP_SERVER" || true
            fi
            #
            # Re-Configure HOSTNAME if necessary
            #
            if [ "$HOSTNAME_MUST_BE_RECONFIGURE" = "1" ]; then
                echo "127.0.0.1     localhost
$IPADDR0       $LCSFULLDOMAIN      $HOSTNAME

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
ff02::3 ip6-allhosts" > /etc/hosts
            fi
    ;;
    *)
        echo "usage: $0 {configure|possible|needed}" >&2
        exit 1
    ;;
esac
