#!/bin/bash
#
# Script de generation du fichier /etc/sudoers pour LCS
#
# 25/10/2009 - Simon Cavey - simon.cavey@crdp.ac-caen.fr
# Projet LCS

# On sauvegarde le fichier sudo d'origine
if [ ! -e "/etc/sudoers.lcs-sauve" ]; then
	cp /etc/sudoers /etc/sudoers.lcs-sauve
fi

# on copie le fichier sudoers d'origine
cp /etc/sudoers /etc/sudoers.in

# on ajoute les entrees LCS
echo "### Sudo-entree generated by lcs-make-sudoers  ###"  >> /etc/sudoers.in
for i in /etc/lcs/sudo.d/* ; do
	echo "### LCS-$i : entree sudo de $i"  >> /etc/sudoers.in
	cat $i >> /etc/sudoers.in 
 	echo "###"
done

# On ouvre sudoers en ecriture
chmod 700  /etc/sudoers

# suppresion de doublons et ecriture du fichier sudoers:
# On test si le deuxieme champs est unique
awk '!x[$2]++' /etc/sudoers.in > /etc/sudoers

# On remet les droits sur /etc/sudoers
chmod 440  /etc/sudoers


# On test le resultat et remet le backup si failed 
visudo -c
if [ "$?" -ne "0" ]; then
	echo "Erreur lors de la gereration du fichier sudo"
	cp /etc/sudoers.lcs-sauve /etc/sudoers 
	exit 1
fi
 
