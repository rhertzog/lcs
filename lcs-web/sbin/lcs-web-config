#!/bin/sh

# /usr/sbin/lcs-web-config

set -e
exit_fatal() {
	echo "Fatal: $1" >&2
	exit 0
}

. /usr/share/slis/slis-common.sh

# Load LCS config
[ ! -e /etc/lcs/lcs.conf ] && exit_fatal "missing /etc/lcs/lcs.conf"
. /etc/lcs/lcs.conf

case "$1" in
    possible)
        # Is the LDAP server reachable ?
        if pgrep -u mysql mysqld >/dev/null && ldapsearch -x "(uid=admin)($LDAP_BASE_DN)" 2>/dev/null | grep -q "^dn: "; then
            exit 0
        else
            exit 1
        fi
    ;;
    needed)
	exit 0
    ;;
    configure)
        # Configure LCS Web
        #
        # Add LCS profile conf in etc
        mv /etc/profile /etc/profile.lcsav
        cp /var/lib/lcs/web/profile /etc/profile
        # Patch /etc/skel/public_html/index.html.in
	if [ -e /etc/skel/public_html/index.html.in ]; then
	    sed -e "s/##HOST##/$DOMAIN/g" /etc/skel/public_html/index.html.in \
		>/etc/skel/public_html/index.html
	    rm /etc/skel/public_html/index.html.in
	fi
        # Patch files /etc/LcSeConfig.php.in /var/www/index.html.in /var/www/lcs/includes/config.inc.in 
        echo "Patch des fichiers de conf LCS"
        sed -e "s|@@PASSWORD@@|"$MYSQLPW"|g" /etc/LcSeConfig.ph.in >/etc/LcSeConfig.ph
        chmod 640 /etc/LcSeConfig.ph
        chown root:www-data /etc/LcSeConfig.ph
        sed -e "s|@@PASSWORD@@|"$LCSMGRPASS"|g" /var/www/lcs/includes/config.inc.in >/var/www/lcs/includes/config.inc.php
        chown www-data:www-data /var/www/lcs/includes/config.inc.php

        # Réinitialisation password account admin lcs if initial install
	echo "Réinitialisation du mpd du compte admin lcs"
	/usr/share/lcs/sbin/userChangePwd.pl admin admin

        # Add right stats_can_read
        if ! ldapsearch -x "(cn=stats_can_read)($LDAP_BASE_DN)" 2>/dev/null | grep -q "^dn: "; then
            echo "dn: cn=stats_can_read,ou=Rights,$LDAP_BASE_DN
objectClass: groupOfNames
cn: stats_can_read
member: uid=admin,ou=People,$LDAP_BASE_DN" > /var/lib/lcs/stats_can_read.ldif
            ldapadd -x -D "cn=$LDAP_ADMIN_RDN,$LDAP_BASE_DN" -w $LDAP_ADMIN_PW -f /var/lib/lcs/stats_can_read.ldif
            rm -f /var/lib/lcs/stats_can_read.ldif
        fi

        # Create webmaster.etab account
        if ! getent passwd webmaster.etab >/dev/null; then
            echo "Creation compte webmaster.etab"
            sed -e "s|#PEOPLE#|$LDAP_PEOPLE_RDN|g" \
                -e "s|#BASEDN#|$LDAP_BASE_DN|g" \
                -e "s|#MAILDOMAIN#|$LDAP_MAIL_DOMAIN|g" \
                /var/lib/lcs/web/ldif/webmasteretab.ldif.in > /var/lib/lcs/web/ldif/webmasteretab.ldif
            ldapadd -x -D "cn=$LDAP_ADMIN_RDN,$LDAP_BASE_DN" -w $LDAP_ADMIN_PW -f /var/lib/lcs/web/ldif/webmasteretab.ldif
            if [ ! -d /home/webmaster.etab ];then
                mkdir /home/webmaster.etab
            fi
            chown root:lcs-users /home/webmaster.etab
            chmod 750 /home/webmaster.etab
            cp -a /etc/skel/* /home/webmaster.etab/
            chown -R webmaster.etab:lcs-users /home/webmaster.etab/public_html
            chown -R webmaster.etab:lcs-users /home/webmaster.etab/Documents
            chmod 770 /home/webmaster.etab/public_html /home/webmaster.etab/Documents
            chown -R webmaster.etab:www-data /home/webmaster.etab/Maildir
            chmod -R 700 /home/webmaster.etab/Maildir
        fi
        # add include lcs apache configuration 55_lcs.conf
        cat >/etc/apache2/lcs-main/55_lcs.conf <<EOF
Alias /Plugins/ /usr/share/lcs/Plugins/
Alias /Modules/ /usr/share/lcs/Modules/
EOF
        # add include lcs apache configuration 15_files.conf
        cat >/etc/apache2/lcs-main/15_files.conf <<EOF
<Files *.py>
Order allow,deny
Deny from all
</Files>
EOF
        # Installation menu.d if not present
        if [ ! -d /var/www/lcs/includes/menu.d ]; then
            cp -r /var/lib/lcs/web/menu.d /var/www/lcs/includes
        fi

        # Configuration webalizer
        echo "Configuration webalizer"
        sed -e "s/#HOSTNAME#/`hostname`/g" /var/lib/lcs/web/webalizer/webalizer.conf.in >/etc/webalizer/webalizer.conf

        # For compatibilty with old plugins
        ln -sf /usr/sbin/apache2ctl /usr/sbin/apachectl

        # restart apache2
        invoke-rc.d apache2 restart
    ;;
    *)
        echo "usage: $0 {configure|possible|needed}" >&2
        exit 1
    ;;
esac
