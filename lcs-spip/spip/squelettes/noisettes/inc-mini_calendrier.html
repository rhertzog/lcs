#CACHE{7200}
<?php

include_once _DIR_RESTREINT_ABS."base/abstract_sql.php";

if (!is_callable(sql_select)) {
  function sql_select($fields, $table, $cond) {
    return spip_abstract_select($fields, $table, $cond);
  }
}
if (!is_callable(sql_fetch)) {
  function sql_fetch($r) {
    return spip_abstract_fetch($r);
  }
}

$calendrier_mois=$_GET['calendrier_mois'];
$calendrier_annee=$_GET['calendrier_annee'];
$lang = '#LANG';
$oldlang = $GLOBALS['spip_lang'];
$GLOBALS['spip_lang'] = $lang;
$months = array('', 'janvier', 'fevrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'aout', 'septembre', 'octobre', 'novembre', 'decembre');
$days = array('di', 'lu', 'ma', 'me', 'je', 've', 'sa');
$GLOBALS['spip_lang'] = $oldlang;
if ($test_mini_agenda_deja_present!=1 &&!function_exists('mkdate')) {
	function mkdate($month, $day, $year) {
		return mktime(0, 0, 0, $month, $day, $year);
	}

	function preparation_URL($texte_URL,$mois_URL,$annee_URL) {
    $position = StrPos($texte_URL,"calendrier_mois");
    $texte_remplacement = "calendrier_mois=".$mois_URL."&amp;calendrier_annee=".$annee_URL;
    if ($position!==FALSE)
        {
        $texte_URL = substr_replace ($texte_URL,$texte_remplacement,$position);}
        else  { $presence = StrPos($texte_URL,"?");
                if ($presence === false)
                  {$texte_URL = $texte_URL."?".$texte_remplacement;}
                else
                  {$texte_URL = $texte_URL."&amp;".$texte_remplacement;}
              }
    return $texte_URL.'&amp;lang=#LANG';
	}
}

if(isset($GLOBALS['var_nav_month'])) {
	$cal_day = mkdate($GLOBALS['var_nav_month'], 1, $GLOBALS['var_nav_year']);
} else {
	$cal_day = time();
}

$D = intval(date('d', $cal_day));
if (isset($calendrier_mois)) {
$M = $calendrier_mois;
} else {$M = intval(date('m', $cal_day));}
if (isset($calendrier_annee)) {
$Y = $calendrier_annee;
} else {$Y = intval(date('Y', $cal_day));}
$events = array();
$test_mini_agenda_deja_present = 1;

$datedebut = date("Ymd", mkdate($M, $D - 31, $Y));
$datefin = date("Ymd", mkdate($M, $D + 31, $Y));

// Articles publié ou modifiés
//if (isset($GLOBALS['meta']['acsAgendaBulleVoirArticlesModifies']) && ($GLOBALS['meta']['acsAgendaBulleVoirArticlesModifies'] == 'oui'))
//	$sql_modif = " OR (date_modif BETWEEN '$datedebut' AND '$datefin')";
$r = sql_select(array('id_evenement','id_article','date_debut','date_fin','titre','descriptif','lieu','adresse','inscription','places','horaire'), 'spip_evenements', "");
while($article = sql_fetch($r)) {
//	$heure_debut = ereg_replace("^.*([0-9]{2}):([0-9]{2}):([0-9]{2})$", "\\1h\\2", $article['date']);
	$date_debut = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", "\\1\\2\\3", $article['date_debut']);
	$date_fin = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", "\\1\\2\\3", $article['date_fin']);
	$evnmtAffiche="";
	if (!isset($events[$date])) 
		$events[$date_debut] = array();
	if (($date_debut > $datedebut) && ($date_debut < $datefin)) {
		$events[$date_debut][ ] = array(
			'class' => 'publie',
			'type' => 'article',
			'heure' => $heure,
			'idevnmt' => $article['id_evenement'],
			'idart' => $article['id_article'],
			'date_debut' => $article['date_debut'],
			'date_fin' => $article['date_debut'],
			'title' => $article['titre'],
			'descriptif' => $article['descriptif'],
			'lieu' => $article['lieu'],
			'adresse' => $article['adresse'],
			'inscription' => $article['inscription'],
			'places' => $article['places'],
			'horaire' => $article['horaire']);
	}
}

$mes = $months [$M];
if ($M==1){
    $calendrier_mois_moins=12;
    $calendrier_annee_moins=$Y-1;}
else {
    $calendrier_mois_moins=$M-1;
    $calendrier_annee_moins=$Y;}
if ($M==12){
    $calendrier_mois_plus=1;
    $calendrier_annee_plus=$Y+1;}
else {
    $calendrier_mois_plus=$M+1;
    $calendrier_annee_plus=$Y;}

$self = (isset($_GET['selfurl']) ? $_GET['selfurl'] : '#SELF');

?>

<script type="text/javascript">
<!--
var idBulleT;
var chrono = null;
var delai = "500";
var x,y;
var shiftx = -20;

if (self.innerHeight) // all except Explorer
{
	x = self.innerWidth;
	y = self.innerHeight;
}
else if (document.documentElement && document.documentElement.clientHeight)
	// Explorer 6 Strict Mode
{
	x = document.documentElement.clientWidth;
	y = document.documentElement.clientHeight;
}
else if (document.body) // other Explorers
{
	x = document.body.clientWidth;
	y = document.body.clientHeight;
}

//-->
</script>
<div class="ajax">
<a name="mini-calendrier"></a>
<table width="100%" style="text-align:center; padding:2px;" class="small_mini">
<tr class="calendar_this_month">
	<th colspan="7" style="vertical-align:middle">
		<?php
		echo '<a id="agenda_prev" href="'.preparation_URL($self,$calendrier_mois_moins,$calendrier_annee_moins).'" title="Mois pr&eacute;c&eacute;dent" class="ajax"><img src="'.find_in_path('i/fleche-left.png').'" alt="&lt;&lt;" style="vertical-align:middle;width:16px;height:16px;" /></a>&nbsp;&nbsp;<a href="spip.php?page=agenda&amp;annee='.$Y.'&amp;mois='.$M.'">'.$mes.' '.$Y.'</a>&nbsp;&nbsp;<a id="agenda_next" href="'.preparation_URL($self,$calendrier_mois_plus,$calendrier_annee_plus).'" title="Mois suivant" class="ajax"><img src="'.find_in_path('i/fleche-right.png').'" alt="&gt;&gt;" style="vertical-align:middle;width:16px;height:16px;" /></a>';
		?>
	</th>
</tr>
<tr>
	<?php

	for($i = 1; $i < 8; $i++) {
		echo '<th style="width:14%;" class="calendar_head_mini">'.$days[$i%7].'</th>';
	}
	$TempD = 1;
	if(date('w', mkdate($M, 1, $Y)) != 1) {
		echo '</tr><tr>';
		$tmp = '';
		while(date('w', mkdate($M, $TempD, $Y)) != 1) {
			$TempD--;
			$case = '<td  style="width:14%;vertical-align:top" class="calendar_not_this_month">';
			$case .= date('j', mkdate($M, $TempD, $Y));
			$date = date('Ymd', mkdate($M, $TempD, $Y));

			$case .= '</td>';
			$tmp = $case.$tmp;
		}
		echo $tmp;
	}
	$TempD = 1;
	while((date('m', mkdate($M, $TempD, $Y)) == $M) || (date('w', mkdate($M, $TempD, $Y)) != 1)) {
		if(date('w', mkdate($M, $TempD, $Y)) == 1) {
			echo '</tr><tr>';
		}
		echo '<td   style="width:6%;vertical-align:top
		" class="calendar_'.(date('m', mkdate($M, $TempD, $Y)) != $M ? 'not_' : '').'this_'.(date('Ymd', mkdate($M, $TempD, $Y)) == date('Ymd') ? 'day' : 'month').'">';
		$date = date('Ymd', mkdate($M, $TempD, $Y));
		if (isset($events[$date])) {
				$evt = '';
	/*
	#A conserver
	<a href="spip.php?'.$event['type'].''.$event['idart'].'&amp;calendrier_mois='.$M.'&amp;calendrier_annee='.$Y.'">
	*/
				foreach($events[$date] as $event) {
					$evt .= '<div class=" '.$event['class'].'"><a href="spip.php?'.$event['type'].''.$event['idart'].'&amp;calendrier_mois='.$M.'&amp;calendrier_annee='.$Y.'">'.$event['title']."</a><br />".$event['date_debut']." : ".$event['horaire']."<br />".$event['lieu']." - ".$event['adresse']."<br />".$event['descriptif']."</div>\r";

				}
				echo '<span class="jourEvnmt">'.
					'<a href="#mini-calendrier"  class="agenda_mini bouton_'.$event['idevnmt'].'" title="'.$event['title'].'">'. date('j', mkdate($M, $TempD, $Y)) .'</a></span>';
		}
		else {
			echo '<a>'.date('j', mkdate($M, $TempD, $Y)).'</a>';
		}
		echo '</td>';
		$TempD++;
	}
	?>
</tr>
</table>
</div>
