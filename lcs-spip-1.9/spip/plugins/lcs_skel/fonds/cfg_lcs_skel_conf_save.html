#CACHE{0}
<!-- titre=<multi>[fr]Personnalisation de l'affichage public</multi>-->
<!-- descriptif=<multi>[fr]Personnalisation du squelette.</multi>
<br /><a href="<?$_SERVER['REQUEST_URI']?>/doc/spip/html/lcs_skel.html#conf_generale" class="spip_out" title="Voir la doc">Vers documentation</a>
-->
<!-- refus=Rien &agrave; faire par ici!
<br />Vous ne pouvez pas acceder &agrave; ce formulaire !
<br />Vous devez &ecirc;tre administrateur et connect&eacute;.
 -->
<!-- nom=lcs_skel_conf -->
<!-- onglet=lcs_skel_conf -->
<!-- liens*=lcs_skel_conf -->
<!-- liens*=lcs_skel_conf_accueil -->
<!-- liens*=lcs_skel_conf_rubriques -->
<!-- liens*=lcs_skel_conf_articles -->
<!-- liens*=lcs_skel_conf_couleurs -->
<!-- liens*=lcs_skel_conf_background -->
<!-- liens*=lcs_skel_conf_slide_show-->
<!-- liens*=lcs_skel_conf_infos_legales-->
<!-- liens*=lcs_skel_conf_credits-->
<!-- liens*=lcs_skel_conf_save-->

<!-- icone=img_pack/logo_lsc_24.png-->
<form method="post" id="form_cfg_lcs_skel" action="#SELF">
	<fieldset>
		<legend>Sauvegarder la configuration</legend>
			<?php
			$rep=_DIR_PLUGIN_LCS_SKEL."tmp/dump/";
				$dir = opendir($rep); 
				$ext = array("png", "gif", "jpg");
				if (isset($_POST['submit'])) 
				if (isset($_POST['nom_conf'])) 
					$nom_conf = $_POST['nom_conf'];
				if (isset($nom_conf)){
					if (isset($GLOBALS['meta']['lcs_skel_conf'])){
						if (!@opendir(_DIR_PLUGIN_LCS_SKEL."tmp/dump/".$nom_conf)){
							mkdir (_DIR_PLUGIN_LCS_SKEL."tmp/dump/".$nom_conf, 0777);
							mkdir (_DIR_PLUGIN_LCS_SKEL."tmp/dump/".$nom_conf."/lcs_skel_conf_background", 0777);
							mkdir (_DIR_PLUGIN_LCS_SKEL."tmp/dump/".$nom_conf."/lcs_skel_conf_entete", 0777);
						}
						foreach ($ext as $key => $val) {
							$file = _DIR_IMG."config/lcs_skel_conf_background/img_body.".$val;
							$file2 = _DIR_IMG."config/lcs_skel_conf_entete/logo_entete.".$val;
							$newfile =  _DIR_PLUGIN_LCS_SKEL."tmp/dump/".$nom_conf."/lcs_skel_conf_background/img_body.".$val;
							$newfile2 =  _DIR_PLUGIN_LCS_SKEL."tmp/dump/".$nom_conf."/lcs_skel_conf_entete/logo_entete.".$val;
							file_exists($file) ? copy($file, $newfile) : '';
							file_exists($file2) ? copy($file2, $newfile2) : '';
						}
#						$date=date('His');
						$lcs_skel_conf=$GLOBALS['meta']['lcs_skel_conf'];
						$Fnm =_DIR_PLUGIN_LCS_SKEL."tmp/dump/".$nom_conf.".csv";
						if (file_exists($Fnm)){/*unlink($Fnm);*/$mess="Le fichier existe";}				
						$s = $nom_conf.".csv";
						$inF = fopen($Fnm,"w");
						fwrite($inF,$lcs_skel_conf);
						fclose($inF);
					}
					while ($f = readdir($dir)) {
						if((is_file($rep.$f))&&($f==$s)) {
								echo "<div class='alert'>La sauvegarde de la configuration <strong>".$f."</strong> est r&eacute;ussie!</div>";
						}
					}
				}
			?>
		<ul>
		<li>
			<small>Les sauvegardes sont enregistr&eacute;es dans le dossier :<br /> <? echo $rep;?></small>
		</li>
		<li>
		<div class="labels_cfg_lcs_skel">
			<label for="nom_conf">Nom de la sauvegarde : </label><br />
			<input type="text" name="nom_conf" value="" />
			<input type="submit" name="submit" value="Sauvegarder" />
		</div>
		</li>
		</ul>
	</fieldset>
		<fieldset>
		<legend>Restaurer une configuration</legend>
			<?php
			if (isset($_POST['submit2'])) {
				if (isset($_POST['restor_conf'])) {
					$restor_conf = $_POST['restor_conf'];
					$Fnm =_DIR_PLUGIN_LCS_SKEL."tmp/dump/".$restor_conf;
#					echo $restor_conf."<br />";
#					echo $Fnm."<br />";
					if (file_exists($Fnm)) {
						$inF = fopen($Fnm,"r");
						while (!feof($inF)) {
							$ctn = fgets($inF, 4096);
							$totalctn .=$ctn;
#							echo $ctn."<br />";
						}
					}
					$ext = array("png", "gif", "jpg");
					$nm_rep = ereg_replace('.csv','',$restor_conf);

					foreach ($ext as $key => $val) {
						$file = _DIR_IMG."config/lcs_skel_conf_background/img_body.".$val;
						$file2 = _DIR_IMG."config/lcs_skel_conf_entete/logo_entete.".$val;
						$newfile =  _DIR_PLUGIN_LCS_SKEL."tmp/dump/".$nm_rep."/lcs_skel_conf_background/img_body.".$val;
						$newfile2 =  _DIR_PLUGIN_LCS_SKEL."tmp/dump/".$nm_rep."/lcs_skel_conf_entete/logo_entete.".$val;
						file_exists($newfile) ? copy($newfile, $file) : '';
						file_exists($newfile2) ? copy($newfile2, $file2) : '';
					}
					/*
global 	$connect_statut;
					if ($connect_statut == '0minirezo') {
					ecrire_meta('lcs_skel', $totalctn);
					ecrire_meta();
					}else{echo"ça marche pô";}
					$r=$GLOBALS['meta']['lcs_skel_conf'];
					echo $r."<hr />";
					echo $totalctn;
					*/
					
					$s = spip_query("SELECT nom, valeur FROM spip_meta WHERE nom='lcs_skel_conf'");
					if(!spip_fetch_array($s)){
						$up= spip_query("INSERT INTO spip_meta SET nom='lcs_skel_conf', valeur='".$totalctn."'");
					} else {
						$up= spip_query('UPDATE spip_meta SET valeur=\''.$ctn.'\' WHERE nom=\'lcs_skel_conf\'');
					}
					if (!$up)$mess = " <div class='alert'>Erreur dans la restauration</div>"; else $mess = "<div class='alert'>Votre sauvegarde <strong>".$nm_rep."</strong> est restaurée!</div> ";
					echo $mess;	
				}
				if ($GLOBALS['connect_statut'] == "0minirezo" AND $GLOBALS["connect_toutes_rubriques"]) {
					$mc=_DIR_TMP."meta_cache.txt"; 
					if (file_exists($mc)) {
						unlink($mc);					
					}
				}

			}
			?>
		<ul>
		<li>
		<div class="labels_cfg_lcs_skel">
			<label for="restor_conf">Choisissez la configuration &agrave; restaurer : </label><br />
			<select name="restor_conf">
					<option value="">  </option>
			<?php
						$dir = opendir($rep); 
						while ($f = readdir($dir)) {
							if(is_file($rep.$f)) {
								echo "<option value='".$f."'>".$f."  </option>";
							}
						}
			?>
			</select>
		</div>
		</li>
		<li>
		<?php
			$taille_cache = spip_fetch_array(spip_query("SELECT SUM(taille) AS n FROM spip_caches WHERE type='t'"));
			$message_cache = 
				($taille_cache = $taille_cache['n']) 
				? _T('taille_cache_octets', array('octets' => taille_en_octets($taille_cache)))
				: _T('taille_cache_vide')
			;
			echo $message_cache;
		?>
		</li>
		<li>
			<input type="submit" name="submit2" value="Restaurer" />
		</li>
		</ul>
	</fieldset>

</form>

 
